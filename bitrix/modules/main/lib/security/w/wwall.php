<? namespace Bitrix\Main\Security\W;$GLOBALS['____1566385306']= array(base64_decode('dGl'.'tZ'.'Q=='),base64_decode('d'.'G'.'ltZQ=='),base64_decode('a'.'nNvbl9kZ'.'WNvZ'.'GU='),base64_decode('YX'.'JyYXlfbWVyZ2U='),base64_decode(''.'am9p'.'bg='.'='),base64_decode(''.'am'.'9pb'.'g=='),base64_decode('am9pbg'.'=='),base64_decode('YXJyYXlfc'.'G9'.'w'),base64_decode('YXJyYXlf'.'c2hpZn'.'Q='),base64_decode('YXJyYXl'.'fc2h'.'pZnQ='),base64_decode('YX'.'JyYXlfc'.'2hpZ'.'nQ='),base64_decode('YXJ'.'yY'.'Xlfc2hpZn'.'Q='),base64_decode(''.'Y'.'XJy'.'YXlfbWVyZ2U='),base64_decode('a'.'XNfYXJyYXk='),base64_decode('YXJyY'.'XlfbWVyZ2U='),base64_decode('aW5f'.'YXJyYXk='),base64_decode('aW5fYXJyYXk'.'='),base64_decode('aW5'.'fYXJyYXk='),base64_decode('a'.'W'.'5f'.'YX'.'JyYXk'.'='),base64_decode(''.'aW5fYXJyYXk='),base64_decode('dGltZQ=='),base64_decode('dGltZ'.'Q=='),base64_decode(''.'YXJy'.'Y'.'Xlf'.'bW'.'Fw'),base64_decode(''.'anNvbl9lbm'.'NvZGU='),base64_decode('a'.'nNvb'.'l9'.'lbm'.'Nv'.'ZGU='),base64_decode('am9'.'pbg'.'=='));if(!function_exists(__NAMESPACE__.'\\___609998799')){function ___609998799($_1876034447){static $_613664596= false; if($_613664596 == false) $_613664596=array('V1dBTEx'.'fT'.'E'.'9DS'.'w==','c2'.'V'.'jdXJ'.'pdH'.'k'.'=','Y2'.'F'.'jaGU'.'=',''.'dH'.'R'.'s','RE'.'FUQQ==',''.'eyI=','V'.'1'.'dBT'.'ExfTE9DSw'.'='.'=','c'.'2V'.'jdXJp'.'dHk=','U0VDV'.'VJJVFl'.'fV1'.'dBTEx'.'fRVhDRVB'.'US'.'U'.'9O',''.'RkFJTF9DSEVD'.'S0lORw==','Q2F'.'u'.'IG'.'5vdC'.'Bl'.'eGVjd'.'XRlIHd3Y'.'WxsIH'.'J'.'1b'.'G'.'V'.'zOiA=','IFRyYWN'.'lOiA=','UkV'.'RVUVT'.'VF9'.'VUkk=','a2V5cw==','d'.'mFsdW'.'Vz','U0'.'VDVVJJVFlfV1dBTExfTU'.'9ESUZZ','Lg==','U0VDVVJJVFlfV1d'.'BTEx'.'fVU5TRVQ=',''.'Lg='.'=',''.'U0VD'.'VVJJV'.'F'.'lf'.'V1d'.'BT'.'ExfRVh'.'JVA==','Lg==',''.'Z2xvYmFs','a2V5cw==','dmF'.'sd'.'WVz',''.'Z2V0','Z2V0','cG9'.'zdA==','cG9z'.'dA==','Y29'.'va2ll','Y29v'.'a2l'.'l','cmVxdWVz'.'dA='.'=','cm'.'V'.'xdWVzdA==',''.'Z2x'.'vYmFs','Z'.'2xv'.'YmFs','bWFpbl9zZWM=','V1'.'d'.'BTE'.'xfQUNUVUFMS'.'VpF'.'X1JV'.'TEVT','dg='.'=','dmVyc2lvbg'.'==','aQ==','aXNJbnN'.'0Y'.'Wxs'.'Z'.'WQ=','c29ja2V0VGl'.'t'.'ZW'.'91dA='.'=','c'.'3RyZWFt'.'VGl'.'tZW91d'.'A==','KCc=','ZGF0'.'YQ==','JywgJw==',''.'bW9k'.'dWxl',''.'JywgJw='.'=','bW'.'9'.'k'.'dWxlX3ZlcnNpb24'.'=','Jyk=','LC'.'A=','U0VD'.'VV'.'J'.'JVF'.'lfV1d'.'BTExfRVhDRVBUSU9O','bWF'.'pbg==',''.'Rk'.'FJT'.'F9SRUZS'.'RV'.'N'.'ISU5H','Q'.'2'.'F'.'uI'.'G5vdCByZWZyZX'.'NoIHd3YWx'.'sI'.'HJ1b'.'G'.'VzOiA=','I'.'F'.'Ry'.'Y'.'WNlOiA=','ZGF0YQ==','eyI=',''.'LS0tLS'.'1CRU'.'d'.'JTi'.'BQV'.'UJMS'.'UMgS'.'0'.'VZLS0t'.'LS0=',''.'C'.'k1JS'.'U'.'JJ'.'akFOQm'.'dr'.'c'.'Whr'.'a'.'Uc5dzBCQVFF'.'R'.'k'.'F'.'BT0NBUThBTUlJQk'.'N'.'nS0NB'.'UUVBcThRRT'.'BI'.'am1I'.'S'.'lVTd'.'FdWNm4wemEK'.'U'.'l'.'ZvTHgwM'.'kt6Ym'.'Z'.'yYl'.'MvUD'.'ZzV'.'2'.'F'.'4VHp3OFNlR1'.'R'.'0YlRDT'.'3JwSGk'.'1UUY2T'.'1J'.'5'.'alovWHh6L0tMVT'.'FHYm9'.'mOUNaM'.'wo0'.'ejdT'.'a3F'.'VdD'.'Y'.'2aWJYdk9GQn'.'g0'.'ZncvQVB'.'QUkdEcXRtMG5E'.'M2ZnR3N1M1J'.'lUGd3'.'Mjlp'.'OCt2'.'bTdt'.'dEJ'.'L'.'SlVZbDR'.'yClZw'.'Y'.'jZzZlpFVDl'.'L'.'RWI2VD'.'F'.'IRFltRXZjMWh'.'xL2lpdX'.'l4'.'TH'.'J'.'aWmk1'.'U'.'TZVZmY0VUV2'.'VEkrNjhzc0ZSa1Erb'.'3dU'.'UnkKZU9JTW'.'J'.'G'.'a'.'E0vVVRtZlZZ'.'YlRSRnk'.'y'.'b1V'.'ROFdN'.'emEybko1U2F'.'oem'.'kx'.'VUt'.'PMWpB'.'alhUUFJy'.'em'.'M3QWp1N'.'jM5ajFPMAp'.'wcHFmbTV4Z1'.'dsRk'.'FKa0'.'hRVGd'.'iZ'.'G'.'Q'.'1QVdxR'.'E'.'ZRa3'.'Q5'.'SEtrWS'.'tUbmZ'.'CT'.'E'.'d'.'WTXZWeVB3'.'V'.'EhOV1F'.'ZQXc0eHBn'.'L3dBCl'.'p3S'.'URBUUFC'.'Ci0tLS0tR'.'U5E'.'IFB'.'VQkxJQyBL'.'RVkt'.'LS0tLQ==');return base64_decode($_613664596[$_1876034447]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; class WWall{ const CACHE_RULES_TTL= 10800; private static $_1601252348= 'https://wwall.bitrix.info/rules.php'; protected $_524840274= true; public function handle(){ try{  $_2124230583= Cache::createInstance(); $_2083898051= false; if($_2124230583->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_237222542= $_2124230583->getVars(); if($GLOBALS['____1566385306'][0]()- $_237222542> round(0+4+4+4+4+4)){  $_17453164= Application::getConnection(); $_497289832= RuleRecordTable::getTableName(); $_17453164->truncateTable($_497289832); RuleRecordTable::cleanCache(); $_2124230583->clean(___609998799(0), ___609998799(1));}} elseif($_2124230583->startDataCache()){  $_2124230583->endDataCache($GLOBALS['____1566385306'][1]()); $_2083898051= true;}  $_1937709993= RuleRecordTable::getList([ ___609998799(2) =>[___609998799(3) => round(0+720+720+720+720+720)* round(0+4.8+4.8+4.8+4.8+4.8)* round(0+2.3333333333333+2.3333333333333+2.3333333333333)]])->fetchAll(); foreach($_1937709993 as $_1245639234){ $_1403860011= new PublicKeyCipher; $_1006431085= $_1403860011->decrypt($_1245639234[___609998799(4)], static::__558097499()); if(!str_starts_with($_1006431085, ___609998799(5))){ continue;} $_509029125= $GLOBALS['____1566385306'][2]($_1006431085, true); if(!empty($_509029125)){ $_1324066621= Rule::make($_509029125); $_1635310979= $this->handleRule($_1324066621); $this->applyHandlingResults($_1635310979);}}  if($_2083898051){ $_2124230583->clean(___609998799(6), ___609998799(7));}} catch(\Throwable $_823479399){ $this->logEvent( ___609998799(8), ___609998799(9), ___609998799(10). $_823479399->getMessage(). ___609998799(11). $_823479399->getTraceAsString());}}  public function handleRule(Rule $_1324066621): array{ $_1635310979=[]; if($_1324066621->matchPath($_SERVER[___609998799(12)])){  $_969597490= $this->getContextElements($_1324066621->getContext()); foreach($_969597490 as $_1264726623 => &$_2083467974){ $_1635310979= $GLOBALS['____1566385306'][3]($_1635310979, $this->recursiveContextKeyHandle($_1264726623, $_2083467974,[], $_1324066621));}} return $_1635310979;}  public function applyHandlingResults(array $_1635310979){ $_969597490= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1635310979 as $_1184161767){ $_2083467974=& $_969597490[$_1184161767->getContextName()]; $_1207545035= $_1184161767->getRuleResult(); $_1324066621= $_1184161767->getRule(); if($_1207545035 instanceof ModifyResult){ if($_1324066621->getProcess() === ___609998799(13)){  static::rewriteContextKey( $_1184161767->getContextName(), $_2083467974, $_1184161767->getContextKey(), $_1207545035->getCleanValue());} elseif($_1324066621->getProcess() === ___609998799(14)){ static::rewriteContextValue( $_1184161767->getContextName(), $_2083467974, $_1184161767->getContextKey(), $_1207545035->getCleanValue());} $this->logEvent( ___609998799(15), $_1184161767->getContextName(), $GLOBALS['____1566385306'][4](___609998799(16), $_1184161767->getContextKey()));} elseif($_1207545035 instanceof CheckResult &&!$_1207545035->isSuccess()){ if($_1207545035->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_1184161767->getContextName(), $_2083467974, $_1184161767->getContextKey(),); $this->logEvent( ___609998799(17), $_1184161767->getContextName(), $GLOBALS['____1566385306'][5](___609998799(18), $_1184161767->getContextKey()));} elseif($_1207545035->getAction() === RuleAction::EXIT){ $this->logEvent( ___609998799(19), $_1184161767->getContextName(), $GLOBALS['____1566385306'][6](___609998799(20), $_1184161767->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_524840274= false;} protected function rewriteContextKey($_1264726623, &$_2083467974, $_1046808021, $_1055742191){ $_1224797016= $_1046808021;  $GLOBALS['____1566385306'][7]($_1224797016); $_1224797016[]= $_1055742191; if($_1264726623 === ___609998799(21)){ $_1357617414= $GLOBALS['____1566385306'][8]($_1046808021); $GLOBALS['____1566385306'][9]($_1224797016); if(empty($_1046808021)){ $GLOBALS[$_1055742191]= $GLOBALS[$_1357617414]; unset($GLOBALS[$_1357617414]);} else{ $_2083467974=& $GLOBALS[$_1357617414]; $_1253998655= ArrayHelper::getByNestedKey($_2083467974, $_1046808021);  ArrayHelper::setByNestedKey($_2083467974, $_1224797016, $_1253998655);  ArrayHelper::unsetByNestedKey($_2083467974, $_1046808021);}} else{ $_1253998655= ArrayHelper::getByNestedKey($_2083467974, $_1046808021);  ArrayHelper::setByNestedKey($_2083467974, $_1224797016, $_1253998655);  ArrayHelper::unsetByNestedKey($_2083467974, $_1046808021);}} protected function rewriteContextValue($_1264726623, &$_2083467974, $_781005736, $_1253998655){ if($_1264726623 === 'global'){ $_1357617414= $GLOBALS['____1566385306'][10]($_781005736); if(empty($_781005736)){ $GLOBALS[$_1357617414]= $_1253998655;} else{ $_2083467974=& $GLOBALS[$_1357617414]; ArrayHelper::setByNestedKey($_2083467974, $_781005736, $_1253998655);}} else{  ArrayHelper::setByNestedKey($_2083467974, $_781005736, $_1253998655);}} protected function unsetContextValue($_1264726623, &$_2083467974, $_781005736){ if($_1264726623 === 'global'){ $_1357617414= $GLOBALS['____1566385306'][11]($_781005736); if(empty($_781005736)){ unset($GLOBALS[$_1357617414]);} else{ $_2083467974=& $GLOBALS[$_1357617414]; ArrayHelper::unsetByNestedKey($_2083467974, $_781005736);}} else{ ArrayHelper::unsetByNestedKey($_2083467974, $_781005736);}}  protected function recursiveContextKeyHandle(string $_1264726623, array &$_2083467974, array $_1997321601, Rule $_1324066621): array{  $_1635310979=[]; foreach($_2083467974 as $_1950428223 => $_1253998655){ $_781005736= $GLOBALS['____1566385306'][12]($_1997321601,[$_1950428223]); if($_1324066621->matchKey($_781005736)){  if($_1324066621->getProcess() === ___609998799(22)){ $_1207545035= $_1324066621->evaluate($_1950428223);} elseif($_1324066621->getProcess() === ___609998799(23)){ $_1207545035= $_1324066621->evaluateValue($_1253998655);}  if(!empty($_1207545035) && $_1207545035 instanceof RuleResult){ $_1635310979[]= new HandlingResult($_1264726623, $_781005736, $_1207545035, $_1324066621);}}  if($GLOBALS['____1566385306'][13]($_1253998655)){ $_1635310979= $GLOBALS['____1566385306'][14]($_1635310979, $this->recursiveContextKeyHandle( $_1264726623, $_2083467974[$_1950428223], $_781005736, $_1324066621));}} return $_1635310979;} protected function getContextElements(array $_1629153403){ $_617214020=[]; if($GLOBALS['____1566385306'][15](___609998799(24), $_1629153403, true)){ $_617214020[___609998799(25)]= &$_GET;} if($GLOBALS['____1566385306'][16](___609998799(26), $_1629153403, true)){ $_617214020[___609998799(27)]= &$_POST;} if($GLOBALS['____1566385306'][17](___609998799(28), $_1629153403, true)){ $_617214020[___609998799(29)]= &$_COOKIE;} if($GLOBALS['____1566385306'][18](___609998799(30), $_1629153403, true)){ $_617214020[___609998799(31)]= &$_REQUEST;} if($GLOBALS['____1566385306'][19](___609998799(32), $_1629153403, true)){ $_617214020[___609998799(33)]= $GLOBALS;} return $_617214020;} public static function refreshRules(){ try{ $_118634766= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1566385306'][20]()- $_118634766)< static::CACHE_RULES_TTL){ return;} Option::set(___609998799(34), ___609998799(35), $GLOBALS['____1566385306'][21]()); $_1813188672= null;  $_1678811859= $GLOBALS['____1566385306'][22](function($_459681154){ return[___609998799(36) => $_459681154[___609998799(37)], ___609998799(38) => (int) $_459681154[___609998799(39)]];}, ModuleManager::getModulesFromDisk());  $_1938173915= new HttpClient([ ___609998799(40) => round(0+5), ___609998799(41) => round(0+1.6666666666667+1.6666666666667+1.6666666666667)]); $_1554494667= $_1938173915->post( static::$_1601252348,[ 'modules' => $GLOBALS['____1566385306'][23]($_1678811859), 'license' => Application::getInstance()->getLicense()->getHashLicenseKey()]); if($_1938173915->getStatus() == round(0+66.666666666667+66.666666666667+66.666666666667) &&!empty($_1554494667)){ $_1813188672= Json::decode($_1554494667);}  if($_1813188672 !== null){ $_17453164= Application::getConnection(); $_497289832= RuleRecordTable::getTableName(); if(!empty($_1813188672)){ foreach($_1813188672 as $_35124709){ if(!static::checkRuleSign($_35124709)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1566385306'][24]($_35124709));}}}  $_17453164->truncateTable($_497289832);  if(!empty($_1813188672)){ $_1498938776=[]; foreach($_1813188672 as $_35124709){ $_1498938776[]= ___609998799(42). $_17453164->getSqlHelper()->forSql($_35124709[___609998799(43)]). ___609998799(44). $_17453164->getSqlHelper()->forSql($_35124709[___609998799(45)]). ___609998799(46). $_17453164->getSqlHelper()->forSql($_35124709[___609998799(47)]). ___609998799(48);} $_144756404= $GLOBALS['____1566385306'][25](___609998799(49), $_1498938776);  $_17453164->query("INSERT INTO {$_497289832} (DATA, MODULE, MODULE_VERSION) VALUES {$_144756404}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_823479399){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___609998799(50), ___609998799(51), ___609998799(52), ___609998799(53). $_823479399->getMessage(). ___609998799(54). $_823479399->getTraceAsString());}} protected static function checkRuleSign($_1324066621){ $_1403860011= new PublicKeyCipher; $_509029125= $_1403860011->decrypt($_1324066621[___609998799(55)], static::__558097499()); return str_starts_with($_509029125, ___609998799(56));} private static function __558097499(){ $_1901333708= ''; $_1901333708 .= ___609998799(57); $_1901333708 .= ___609998799(58); return $_1901333708;} protected function logEvent($_1099503699, $_398702523, $_635499181){ if($this->_524840274){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1099503699, 'main', $_398702523, $_635499181);}}}?>